---
- name: Uninstall CloudLens Agent from Red Hat VMs with Docker
  hosts: "{{ target_group }}"
  become: yes
  vars_files:
    - ../vars/cloudlens.yaml

  tasks:
    - name: Gather facts about the system
      setup:

    - name: Check if Docker is installed
      ansible.builtin.command: command -v docker
      register: docker_installed
      failed_when: false
      changed_when: false

    - name: Display Docker installation status
      debug:
        msg: "Docker is {{ 'installed' if docker_installed.rc == 0 else 'not installed' }}"

    - name: Check if CloudLens container exists
      ansible.builtin.shell: docker ps -a --filter name={{ cloudlens_agent_container_name }} --format '{{"{{"}}.Names{{"}}"}}'
      register: container_exists
      when: docker_installed.rc == 0
      changed_when: false
      failed_when: false

    - name: Display container status
      debug:
        msg: "CloudLens container {{ 'exists' if container_exists.stdout != '' else 'does not exist' }}"
      when: docker_installed.rc == 0

    - name: Stop CloudLens Agent container if running
      ansible.builtin.shell: docker stop {{ cloudlens_agent_container_name }}
      when: 
        - docker_installed.rc == 0
        - container_exists.stdout != ""
      ignore_errors: yes
      register: stop_result

    - name: Display stop result
      debug:
        var: stop_result.stdout_lines
      when: stop_result is defined

    - name: Remove CloudLens Agent container
      ansible.builtin.shell: docker rm -f {{ cloudlens_agent_container_name }}
      when: 
        - docker_installed.rc == 0
        - container_exists.stdout != ""
      ignore_errors: yes
      register: remove_result

    - name: Display remove result
      debug:
        var: remove_result.stdout_lines
      when: remove_result is defined

    - name: Verify container is removed
      ansible.builtin.shell: docker ps -a --filter name={{ cloudlens_agent_container_name }} --format '{{"{{"}}.Names{{"}}"}}'
      register: verify_removed
      when: docker_installed.rc == 0
      changed_when: false
      failed_when: verify_removed.stdout != ""

    - name: Check if CloudLens sensor image exists
      ansible.builtin.shell: docker images {{ cloudlens_manager_ip_or_FQDN }}/sensor --format '{{"{{"}}.Repository{{"}}"}}'
      register: image_exists
      when: docker_installed.rc == 0
      changed_when: false
      failed_when: false

    - name: Remove CloudLens sensor image if exists
      ansible.builtin.shell: docker rmi {{ cloudlens_manager_ip_or_FQDN }}/sensor:latest
      when: 
        - docker_installed.rc == 0
        - image_exists.stdout != ""
      ignore_errors: yes
      register: image_remove_result

    - name: Display image removal result
      debug:
        var: image_remove_result.stdout_lines
      when: image_remove_result is defined

    - name: Check if Docker daemon.json exists
      ansible.builtin.stat:
        path: /etc/docker/daemon.json
      register: daemon_json_stat

    - name: Read current Docker daemon.json
      ansible.builtin.slurp:
        src: /etc/docker/daemon.json
      register: daemon_json_content
      when: daemon_json_stat.stat.exists

    - name: Remove insecure registry from daemon.json
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        content: "{}"
        mode: '0644'
      when:
        - registry_type == "insecure"
        - daemon_json_stat.stat.exists
      notify: Restart Docker

    - name: Remove CA certificate from VM (for secure registries)
      ansible.builtin.file:
        path: "{{ ca_cert_dir }}/cloudlenscerts.crt"
        state: absent
      when: registry_type == "secure"

    - name: Update CA certificates on Red Hat (for secure registries)
      ansible.builtin.command: update-ca-trust extract
      when: registry_type == "secure"
      notify: Restart Docker

    - name: Ensure Docker configuration changes are applied
      meta: flush_handlers

    - name: Remove /var/log/cloudlens directory
      ansible.builtin.file:
        path: /var/log/cloudlens
        state: absent
      register: log_removal

    - name: Remove /var/tmp/cloudtap directory
      ansible.builtin.file:
        path: /var/tmp/cloudtap
        state: absent
      register: tmp_removal

    - name: Display cleanup summary
      debug:
        msg: |
          CloudLens Agent Cleanup Summary
          ================================
          Cleanup completed successfully
          - Container: Processed
          - Image: Processed
          - Logs: Cleaned
          - Temp files: Cleaned
          
          Note: Docker was NOT removed (check other_containers output above)
      

    - name: Optional - Check for other containers using Docker
      ansible.builtin.shell: docker ps -a --format '{{"{{"}}.Names{{"}}"}}'
      register: other_containers
      when: docker_installed.rc == 0
      changed_when: false

    - name: Display other containers
      debug:
        msg: "Other containers on system: {{ other_containers.stdout_lines if other_containers.stdout_lines | length > 0 else 'None' }}"
      when: docker_installed.rc == 0

    - name: Prompt about Docker removal
      debug:
        msg: |
          WARNING: Docker removal is optional and NOT included by default.
          Other containers may be using Docker: {{ other_containers.stdout_lines | length if other_containers.stdout_lines is defined else 'unknown' }}
          
          To remove Docker, set variable: remove_docker=true

    - name: Stop Docker service (OPTIONAL - only if remove_docker=true)
      ansible.builtin.systemd:
        name: docker
        state: stopped
        enabled: no
      when:
        - remove_docker | default(false) | bool
        - docker_installed.rc == 0
      ignore_errors: yes

    - name: Remove Docker Engine (OPTIONAL - only if remove_docker=true)
      ansible.builtin.yum:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: absent
      when:
        - remove_docker | default(false) | bool
        - ansible_os_family == 'RedHat'
        - docker_installed.rc == 0

    - name: Remove Docker data directory (OPTIONAL - only if remove_docker=true and purge_docker_data=true)
      ansible.builtin.file:
        path: /var/lib/docker
        state: absent
      when:
        - remove_docker | default(false) | bool
        - purge_docker_data | default(false) | bool

    - name: Remove Docker configuration directory (OPTIONAL - only if remove_docker=true)
      ansible.builtin.file:
        path: /etc/docker
        state: absent
      when:
        - remove_docker | default(false) | bool

    - name: Final verification - CloudLens completely removed
      ansible.builtin.shell: |
        # Check for any CloudLens processes
        ps aux | grep -i cloudlens | grep -v grep || echo "No CloudLens processes"
        
        # Check for any CloudLens files
        find /var/log -name "*cloudlens*" 2>/dev/null || echo "No CloudLens logs"
        find /var/tmp -name "*cloudtap*" 2>/dev/null || echo "No CloudLens temp files"
      register: final_check
      changed_when: false
      failed_when: false

    - name: Display final verification
      debug:
        var: final_check.stdout_lines

  handlers:
    - name: Restart Docker
      ansible.builtin.systemd:
        name: docker
        state: restarted
      when: docker_installed.rc == 0
      ignore_errors: yes