---
- name: Deploy CloudLens Agent to Red Hat VMs with Docker
  hosts: "{{ target_group }}"
  become: yes
  vars_files:
    - ../vars/cloudlens.yaml

  tasks:
    - name: Gather facts about the system
      setup:

    - name: Ensure /var/log/cloudlens directory exists
      ansible.builtin.file:
        path: /var/log/cloudlens
        state: directory
        mode: '0755'

    - name: Ensure /var/tmp/cloudtap directory exists
      ansible.builtin.file:
        path: /var/tmp/cloudtap
        state: directory
        mode: '0755'

    - name: Check if Docker is installed
      ansible.builtin.command: command -v docker
      register: docker_installed
      failed_when: false
      changed_when: false

    - name: Debug Docker installation status
      debug:
        msg: "Docker is {{ 'installed' if docker_installed.rc == 0 else 'not installed' }}."

    - name: Install Docker prerequisites
      ansible.builtin.yum:
        name:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
        state: present
      when:
        - docker_installed.rc != 0
        - ansible_os_family == 'RedHat'

    - name: Add Docker repository
      ansible.builtin.command: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo
      when:
        - docker_installed.rc != 0
        - ansible_os_family == 'RedHat'

    - name: Install Docker Engine
      ansible.builtin.yum:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
      when:
        - docker_installed.rc != 0
        - ansible_os_family == 'RedHat'

    - name: Start and enable Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    - name: Re-verify Docker is available after installation
      ansible.builtin.command: command -v docker
      register: docker_available
      failed_when: docker_available.rc != 0
      changed_when: false

    - name: Get Docker version
      ansible.builtin.command: docker --version
      register: docker_version
      changed_when: false

    - name: Display Docker version
      debug:
        msg: "{{ docker_version.stdout }}"

    - name: Configure Docker for insecure registry
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "insecure-registries": ["{{ cloudlens_manager_ip_or_FQDN }}"]
          }
        mode: '0644'
      when: registry_type == "insecure"
      notify: Restart Docker

    - name: Ensure daemon.json changes are applied
      meta: flush_handlers

    - name: Transfer CA certificate from local to VM (for secure registries)
      copy:
        src: "{{ local_ca_path }}"
        dest: "{{ ca_cert_dir }}/cloudlenscerts.crt"
        mode: '0644'
      when: registry_type == "secure"

    - name: Update CA certificates on Red Hat (for secure registries)
      ansible.builtin.command: update-ca-trust extract
      when: registry_type == "secure"
      notify: Restart Docker

    - name: Ensure CA certificate changes are applied
      meta: flush_handlers

    - name: Remove existing CloudLens agent container if exists
      ansible.builtin.shell: "docker rm -f {{ cloudlens_agent_container_name }}"
      ignore_errors: yes

    - name: Pull CloudLens sensor image from registry
      ansible.builtin.shell: >
        docker pull
        {{ cloudlens_manager_ip_or_FQDN }}/sensor:latest
      register: docker_pull_result

    - name: Display pull result
      debug:
        var: docker_pull_result.stdout_lines

    - name: Run CloudLens Agent container with Docker
      ansible.builtin.shell: |
        docker run -d \
        -v /lib/modules:/lib/modules \
        -v /var/log/cloudlens:/var/log/cloudlens \
        -v /var/tmp/cloudtap:/var/cloudtap \
        -v /:/host \
        {% if registry_type == 'secure' %}-v "{{ ca_cert_dir }}:/usr/local/share/ca-certificates:ro" {% endif %} \
        --cap-add NET_BROADCAST --cap-add SYS_ADMIN --cap-add SYS_MODULE \
        --cap-add SYS_RESOURCE --cap-add NET_RAW --cap-add NET_ADMIN \
        --security-opt apparmor=unconfined \
        --name "{{ cloudlens_agent_container_name }}" \
        --restart=always \
        --network=host \
        --log-opt max-size="{{ log_max_size }}" \
        --log-opt max-file="{{ log_max_file }}" \
        "{{ cloudlens_manager_ip_or_FQDN }}/sensor:latest" \
        --accept_eula yes \
        --loglevel debug \
        --project_key "{{ project_key }}" \
        --server "{{ cloudlens_manager_ip_or_FQDN }}" \
        --custom_tags "{{ custom_tags }}" \
        --ssl_verify {% if registry_type == 'secure' %}yes{% else %}no{% endif %}
      register: docker_run_result

    - name: Display container run output
      debug:
        var: docker_run_result

    - name: Wait for container to initialize
      ansible.builtin.pause:
        seconds: 5

    - name: Verify CloudLens agent container is running
      ansible.builtin.shell: >
        docker ps --filter name={{ cloudlens_agent_container_name }} --format '{{"{{"}}.Names{{"}}"}}'
      register: agent_running
      changed_when: false
      failed_when: agent_running.stdout == ""

    - name: Display agent status
      debug:
        msg: "CloudLens agent container '{{ agent_running.stdout }}' is running"

    - name: Get container logs on failure
      ansible.builtin.shell: docker logs {{ cloudlens_agent_container_name }}
      register: container_logs
      when: agent_running.stdout == ""
      ignore_errors: yes

    - name: Display container logs if failed
      debug:
        var: container_logs.stdout_lines
      when: agent_running.stdout == ""

  handlers:
    - name: Restart Docker
      ansible.builtin.systemd:
        name: docker
        state: restarted